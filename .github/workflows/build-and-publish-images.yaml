name: Build all SPK base images

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '32 21 8-14 * SUN' # Kjør den 2. søndagen i hver måned klokken 21:32

jobs:
  rockylinux:
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        os_version: [8, 9]
        distro:
          - type: "-minimal"
            package_manager: microdnf
          - type: " "
            package_manager: dnf
    uses: ./.github/workflows/podman-build-and-publish.yaml
    with:
      image_name: "rockylinux"
      image_tag: "${{ matrix.os_version }}${{ matrix.distro.type }}"
      containerfile: "rocky-linux/Containerfile"
      build_args: "BASE_IMAGE=docker.io/rockylinux/rockylinux:${{ matrix.os_version }}${{ matrix.distro.type }}, OS_VERSION=${{ matrix.os_version }}, PACKAGE_MANAGER=${{ matrix.distro.package_manager }}"
      platforms: "linux/amd64"
      description: "Rocky Linux ${{ matrix.os_version }}${{ matrix.distro.type }} container image for SPK"
      runs_on: ubuntu-latest
      sbom: false # podman på ubuntu støtter ikke --sbom (major-versjon 4 som er for gammel?)

  zulu-openjdk-21-jdk:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: 'zulu-openjdk'
      image_tag: '21-jdk'
      containerfile: 'zulu-openjdk/Containerfile'
      build_args: 'BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal, JAVA_VERSION=21, JAVA_TYPE=jdk'
      platforms: 'linux/amd64'
      description: 'Java 21 JDK (Zulu OpenJDK) container image based on Rocky Linux 9 minimal for SPK'

  zulu-openjdk-21-jre:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: 'zulu-openjdk'
      image_tag: '21-jre'
      containerfile: 'zulu-openjdk/Containerfile'
      build_args: 'BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal, JAVA_VERSION=21, JAVA_TYPE=jre'
      platforms: 'linux/amd64'
      description: 'Java 21 JRE (Zulu OpenJDK) container image based on Rocky Linux 9 minimal for SPK'

  maven-3-9-9-zulu-openjdk-21:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: zulu-openjdk-21-jdk
    permissions:
      contents: read
      packages: write
    with:
      image_name: 'maven'
      image_tag: '3.9.9-zulu-openjdk-21'
      containerfile: 'maven/Containerfile'
      build_args: 'BASE_IMAGE=ghcr.io/statens-pensjonskasse/zulu-openjdk:21-jdk, MAVEN_VERSION=3.9.9'
      platforms: 'linux/amd64'
      description: 'Maven 3.9.9 container image based on Zulu OpenJDK 21 for SPK and Rocky Linux 9 minimal'

  python-3-11:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: python
      image_tag: 3.11
      containerfile: python/Containerfile
      build_args: BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal, PYTHON_VERSION=3.11
      platforms: linux/amd64
      description: Python 3.11 container image based on Rocky Linux 9 minimal for SPK

  python-3-12:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: python
      image_tag: 3.12
      containerfile: python/Containerfile
      build_args: BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal, PYTHON_VERSION=3.12
      platforms: linux/amd64
      description: Python 3.12 container image based on Rocky Linux 9 minimal for SPK

  nodejs-22:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: nodejs
      image_tag: 22
      containerfile: nodejs/Containerfile
      build_args: BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal, NODEJS_VERSION=22, NPM_VERSION=10
      platforms: linux/amd64
      description: Node.js 22 container image based on Rocky Linux 9 minimal for SPK

  nodejs-22-builder:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: nodejs
      image_tag: 22-builder
      containerfile: nodejs/Containerfile
      build_args: |
        BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal,
        NODEJS_VERSION=22,
        NPM_VERSION=10,
        INSTALL_PACKAGES="nodejs curl git nss freetype harfbuzz gcc-c++ make bzip2",
        ADDITIONAL_PACKAGES="xorg-x11-server-Xvfb gtk2-devel gtk3-devel libnotify-devel GConf2 nss libXScrnSaver alsa-lib chromium"
      platforms: linux/amd64
      description: Node.js 22 container image based on Rocky Linux 9 minimal for SPK

  nodejs-24:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: nodejs
      image_tag: 24
      containerfile: nodejs/Containerfile
      build_args: |
        BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal,
        NODEJS_VERSION=24,
        NPM_VERSION=11
      platforms: linux/amd64
      description: Node.js 24 container image based on Rocky Linux 9 minimal for SPK
      sbom: false

  nodejs-24-builder:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    needs: rockylinux
    permissions:
      contents: read
      packages: write
    with:
      image_name: nodejs
      image_tag: 24-builder
      containerfile: nodejs/Containerfile
      build_args: |
        BASE_IMAGE=ghcr.io/statens-pensjonskasse/rockylinux:9-minimal,
        NODEJS_VERSION=24,
        NPM_VERSION=11,
        INSTALL_PACKAGES="nodejs curl git nss freetype harfbuzz gcc-c++ make bzip2",
        ADDITIONAL_PACKAGES="xorg-x11-server-Xvfb gtk2-devel gtk3-devel libnotify-devel GConf2 nss libXScrnSaver alsa-lib chromium"
      platforms: linux/amd64
      description: Node.js 24 container image based on Rocky Linux 9 minimal for SPK
      sbom: false

  php-mssql-8-3:
    uses: ./.github/workflows/podman-build-and-publish.yaml
    permissions:
      contents: read
      packages: write
    with:
      image_name: php-mssql
      image_tag: 8.3
      containerfile: php-mssql/Containerfile
      platforms: linux/amd64
      description: PHP 8.3 container image based on plain ubuntu 22.04
      sbom: false
      runs_on: ubuntu-latest
